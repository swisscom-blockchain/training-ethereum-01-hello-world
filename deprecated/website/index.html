<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Hello World Web </title>
	<script src="./node_modules/web3/dist/web3.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
	<script src="./HelloWorld.abi"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ"
	 crossorigin="anonymous">
</head>

<body>
	<div class="container-fluid">
		<h1>Contract</h1>
		<label>Hint:</label>
		<ul>
			<li>Make sure contract address is correct in the HTML. Current Address:
				<label id="currentContractAddress"></label>
			</li>
			<li>ABI is up to date. See file: ./HelloWorld.abi</li>
		</ul>


		<h2>Smart Contract Events</h2>
		<label id="scEvents"></label>

		<h2>Basic Functions</h2>
		<table class="table">
			<tr>
				<td>
					<label>text Value: </label>
				</td>
				<td>
					<label id="getTextValue"></label>
				</td>
			</tr>

			<tr>
				<td>
					<label>set Text</label>
				</td>
				<td>
					<label>value</label>
					<input id="setTextValue" type="text"></input>
					<button id="btnSetTextValue">Write</button>
				</td>
			</tr>
		</table>

		<h2>Managing Functions</h2>
		<table class="table">
			<tr>
				<td>
					<label>Current interaction account: </label>
				</td>
				<td>
					<label id="currentInteractionAccount"></label>
				</td>
			</tr>
			<tr>
				<td>
					<label>Set interaction account</label>
				</td>
				<td>
					<select name="subject" id="subject"></select>
					<button id="btnSetSubject">Set</button>
				</td>
			</tr>
			<tr>
				<td>
					<label>Unlock account</label>
				</td>
				<td>
					<input id="unlockAccount" type="text">
					<button id="btnUnlockAccount">Unlock</button>
				</td>
			</tr>
		</table>
	</div>

	<script>

		var BigNumber = require('bignumber.js');
		if (typeof web3 !== 'undefined') {
			web3 = new Web3(web3.currentProvider);
		} else {
			web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
		}

		web3.eth.defaultAccount = web3.eth.accounts[0];

		var contractABI = web3.eth.contract(abi);
		var contractAddress = '0xe21977661ac3ad66244b08ef49b9d33961c03c2e';
		var contractInstance = contractABI.at(contractAddress);

		$("#currentContractAddress").text(contractAddress);

		$.each(web3.eth.accounts, function (key, value) {
			$('#subject')
				.append($("<option></option>")
					.attr("value", key)
					.text(value));
		});

		var eventCollection = [];

		var timerRef = setInterval(refreshTimer, 2000);
		refreshTimer();

		function addEvent(eventText) {
			if (eventCollection.length > 10) {
				eventCollection = eventCollection.reverse();
				eventCollection.pop();
				eventCollection = eventCollection.reverse();
			}

			eventCollection.push(eventText);
			var text = eventCollection.join("<br />")
			$("#scEvents").html(text);
		}

		function refreshTimer() {
			$("#currentInteractionAccount").text(web3.eth.defaultAccount);
			$("#getTextValue").text(contractInstance.getTextValue());

		}

		$("#btnSetSubject").click(function () {
			console.log("btnSetSubject");
			web3.eth.defaultAccount = $("#subject option:selected").text();
		});

		$("#btnUnlockAccount").click(function () {
			console.log("btnUnlockAccount");
			var password = $("#unlockAccount").val();
			web3.personal.unlockAccount(web3.eth.defaultAccount, password, 100000);
		});

		$("#btnSetTextValue").click(function () {
			var setTextValue = $("#setTextValue").val();
			console.log("btnSetTextValue. value: " + setTextValue);
			contractInstance.setTextValue(setTextValue);
		});

		//Event registration is not working in ganache. It works with testrpc and ganache-cli
		contractInstance.NewTextValue().watch(function (error, result) {
			if (!error) {
				var from = result.args.from;
				var textValue = result.args.textValue;
				var event = "Event: NewTextValue. from: " + from + ", text: " + textValue;
				console.log(event);
				addEvent(event)
			} else {
				console.error(error);
			}
		});	

	</script>

	<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n"
	 crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
	 crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn"
	 crossorigin="anonymous"></script>
</body>

</html>